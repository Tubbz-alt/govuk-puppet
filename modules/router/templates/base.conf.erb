upstream varnish {
  server localhost:7999;
}

# Function to lowercase a uri
perl_set $uri_lowercase 'sub {
  my $r = shift;
  return lc($r->uri);
}';

# CDN preserves the Host header from original client request and always hits
# this vhost instead of www-origin below.
server {
  server_name         www.gov.uk;
  listen 80;
  # Send the Strict-Transport-Security header
  include             /etc/nginx/add-sts.conf;

  include             /etc/nginx/router_include.conf;
}

server {
  server_name         www.* www-origin.*;
  listen 80;
  # Send the Strict-Transport-Security header
  include             /etc/nginx/add-sts.conf;

  include             /etc/nginx/router_include.conf;
}

server {
  server_name         draft-origin.*;
  listen 80;
  # Send the Strict-Transport-Security header
  include             /etc/nginx/add-sts.conf;

  include             /etc/nginx/router_include.conf;

  add_header X-Robots-Tag "noindex";

  # Redirect for a draft document that was accidentally leaked to the publi
  # with bypass authentication token.
  #
  # Added 30 June 2020 - if this is still hear 6 months later assume it's safe
  # to remove.
  if ($arg_token = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIzOTM0NjUzMi0zMTM5LTQ3MzgtYjI2Mi02NjYxMzIzMjY0MzEifQ.9Fd2ok0BMi7IEnMQF9xlMNzl57nYoiOpz-rdL8QuWNI") {
    rewrite ^/(government/news/leicestershire-coronavirus-lockdown-areas-and-changes)$ <%= @website_root %>/$1? permanent;
  }
}
