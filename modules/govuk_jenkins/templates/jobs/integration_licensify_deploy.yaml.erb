---
- job:
    name: integration-licensify-deploy
    display-name: integration-licensify-deploy
    project-type: freestyle
    description: 'Kicks off a Licensify deploy in the Integration environment'
    properties:
      - build-discarder:
          days-to-keep: 30
          artifact-num-to-keep: 5
    builders:
      - shell: |
          #!/bin/bash

          # Deploy TARGET_APPLICATION to the AWS Integration environment.
          function deploy {
            read -rd '' JSON <<-EOF
              {"parameter": [
                {"name": "TAG", "value": "$TAG"},
                {"name": "TARGET_APPLICATION", "value": "$TARGET_APPLICATION"},
                {"name": "DEPLOY_TASK", "value": "deploy"},
              ]}
          EOF

            echo "Fetching CSRF crumb from Jenkins..."
            CRUMB=$(curl --progress-bar https://<%= @jenkins_integration_aws_api_user %>:<%= @jenkins_integration_aws_api_password %>@<%= @aws_deploy_url %>/crumbIssuer/api/json | jq --raw-output '. | .crumb')

            echo "Starting Deploy_App job with params: $JSON"
            curl --progress-bar -fX POST -H "Jenkins-Crumb:$CRUMB" -d token=<%= @puppet_auth_token %> --data-urlencode json="$JSON" https://<%= @jenkins_integration_aws_api_user %>:<%= @jenkins_integration_aws_api_password %>@<%= @aws_deploy_url %>/job/Deploy_App/build
          }

          # Deploy each Licensify app (licensify, licensify-admin, licensify-feed).
          TARGET_APPLICATION=licensify deploy
          TARGET_APPLICATION=licensify-admin deploy
          TARGET_APPLICATION=licensify-feed deploy
    wrappers:
        - ansicolor:
            colormap: xterm
    parameters:
        - string:
            name: TAG
            description: 'Git tag/committish to deploy'
            default: release
