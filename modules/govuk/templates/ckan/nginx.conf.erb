# Some API paths expose PII, so we block access by default. We allow access to
# specific paths required by other apps which do not expose PII.

# Used by: ckan.publishing.service.gov.uk
# Used for: internationalisation of form controls
location /api/i18n {
  try_files $uri @app;
}

# Used by: datagovuk_publish
# Used for: ckan_v26_ckan_org_sync
location /api/3/action/organization_list {
  try_files $uri @app;
}

# Used by: datagovuk_publish
# Used for: ckan_v26_ckan_org_sync
location /api/3/action/organization_show {
  try_files $uri @app;
}

# Used by: datagovuk_publish
# Used for: ckan_v26_package_sync job
location /api/3/search/dataset {
  try_files $uri @app;
}

# Used by: datagovuk_publish
# Used for: ckan_v26_package_sync job
location /api/3/action/package_show {
  try_files $uri @app;
}

# Additional endpoints advertised in data.gov.uk API docs

# Duplicates above but does not include api version
location /api/action/organization_list {
  try_files $uri @app;
}

location /api/action/package_list {
  try_files $uri @app;
}

location /api/action/organization_show {
  try_files $uri @app;
}

# Additional endpoints requested by users

location /api/action/package_search {
  try_files $uri @app;
}

location /api/3/action/package_search {
  try_files $uri @app;
}

# CSW endpoint

location /csw {
  <%- if @protected -%>
  deny all;
  auth_basic            "Enter the GOV.UK username/password (not your personal username/password)";
  auth_basic_user_file  /etc/govuk.htpasswd;
  satisfy any;
  <%- end -%>

  proxy_pass            http://localhost:<%= @pycsw_port %>;
  proxy_set_header      Host             $host;
  proxy_set_header      X-Real-IP        $remote_addr;
  proxy_set_header      X-Forwarded-For  $proxy_add_x_forwarded_for;
  proxy_set_header      X-Client-Verify  SUCCESS;
  proxy_set_header      X-Client-DN      $ssl_client_s_dn;
  proxy_set_header      X-SSL-Subject    $ssl_client_s_dn;
  proxy_set_header      X-SSL-Issuer     $ssl_client_i_dn;
  proxy_read_timeout    1800;
  proxy_connect_timeout 1800;
}
